<?xml version="1.0"?>
<project name="DavidVerholen_blog"
         default="test-all"
         basedir="."
         description="DavidVerholen_Blog Build">

    <property name="project.builddir" value="${project.basedir}/build"/>

    <target name="test-all" depends="build,test.prepare,test.spec,test.unit,test.integration"/>
    <target name="unit-tests" depends="build,test.prepare,test.unit"/>
    <target name="spec-tests" depends="build,test.prepare,test.spec"/>
    <target name="integration-tests" depends="build,test.prepare,test.integration"/>

    <target name="test.unit">
        <exec executable="${project.builddir}/vendor/bin/phpunit" passthru="true">
            <arg value="-c"/>
            <arg file="${project.builddir}/dev/tests/unit/phpunit.xml"/>
        </exec>
    </target>

    <target name="test.integration">
        <exec executable="${project.builddir}/vendor/bin/phpunit" passthru="true">
            <arg value="-c"/>
            <arg file="${project.builddir}/dev/tests/integration/phpunit.xml"/>
        </exec>
    </target>

    <target name="test.spec">
        <exec executable="bin/phpspec" passthru="true">
            <arg value="run"/>
        </exec>
    </target>

    <target name="clean">
        <delete dir="reports"/>
        <delete dir="${project.builddir}"/>
        <mkdir dir="reports/coverage"/>
        <mkdir dir="reports/tests"/>
    </target>

    <target name="build" depends="clean">
        <composer command="create-project">
            <arg value="magento/project-community-edition"/>
            <arg path="${project.builddir}"/>
        </composer>
        <exec command="chmod +x ${project.builddir}/bin/magento"/>
        <exec command="sudo docker-compose up -d" passthru="true"/>
        <exec command="chmod -R 0777 ${project.builddir}"/>
        <exec command="./waitForMysql.sh" passthru="true"/>
    </target>

    <target name="test.prepare">
        <mkdir dir="${project.builddir}/app/code/DavidVerholen"/>
        <symlink link="${project.builddir}/app/code/DavidVerholen/Blog"
                 target="../../../../src"
                 overwrite="true"/>
        <copy file="test/integration/etc/install-config-mysql.php" todir="${project.builddir}/dev/tests/integration/etc"/>
        <copy file="test/integration/phpunit.xml.dist" tofile="${project.builddir}/dev/tests/integration/phpunit.xml"/>
        <copy file="test/unit/phpunit.xml.dist" tofile="${project.builddir}/dev/tests/unit/phpunit.xml"/>
    </target>
</project>
